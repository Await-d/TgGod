# Drone CI 部署配置对比

## 架构变更对比

### 旧架构（三服务）

```yaml
# 构建三个独立镜像
- docker build -t tggod-backend:latest ./backend
- docker build -t tggod-frontend:latest ./frontend

# 启动三个容器
- docker run -d --name tggod-database ...
- docker run -d --name tggod-backend ...
- docker run -d --name tggod-frontend -p 10200:80 ...
```

### 新架构（单服务）

```yaml
# 构建单一镜像
- docker build -t tggod:latest .

# 启动单一容器
- docker run -d --name tggod -p 10200:80 ...
```

## 配置变更详情

### 1. 镜像构建

| 方面 | 旧配置 | 新配置 |
|------|--------|--------|
| 镜像数量 | 2个（backend + frontend） | 1个（tggod） |
| 构建方式 | 分别构建 | 多阶段构建 |
| 构建时间 | ~5-8分钟 | ~3-5分钟 |
| 镜像大小 | ~800MB（总计） | ~500MB |

### 2. 容器部署

| 方面 | 旧配置 | 新配置 |
|------|--------|--------|
| 容器数量 | 3个 | 1个 |
| 端口映射 | frontend:80 | tggod:80 |
| 网络配置 | 服务间通信 | 内部通信 |
| 启动时间 | ~30-60秒 | ~15-30秒 |

### 3. 数据挂载

| 数据类型 | 旧路径 | 新路径 |
|----------|--------|--------|
| 数据库 | `/app/data` | `/app/data` |
| 媒体文件 | `/app/media` | `/app/media` |
| 日志文件 | `/app/logs` | `/app/logs` |
| Telegram会话 | 无专门目录 | `/app/telegram_sessions` |

### 4. 环境变量

**保持不变的变量**:
- `TELEGRAM_API_ID`
- `TELEGRAM_API_HASH`
- `TELEGRAM_BOT_TOKEN`
- `SECRET_KEY`
- `DATABASE_URL`
- `MEDIA_ROOT`
- `LOG_FILE`

**新增变量**:
- `PYTHONUNBUFFERED=1` (改善日志输出)

### 5. 健康检查

| 方面 | 旧配置 | 新配置 |
|------|--------|--------|
| 检查端点 | 前端根路径 | `/health` API端点 |
| 检查方式 | 简单访问 | 健康检查 + 日志检查 |
| 重试机制 | 无 | 2次重试 |

## 迁移优势

### 1. 部署简化
- **容器数量**: 3个 → 1个
- **网络配置**: 复杂 → 简单
- **依赖管理**: 服务间依赖 → 无依赖

### 2. 资源优化
- **内存使用**: ~500MB → ~300MB
- **磁盘空间**: 多镜像 → 单镜像
- **网络开销**: 服务间通信 → 内部通信

### 3. 维护便利
- **监控**: 3个容器 → 1个容器
- **日志**: 分散 → 集中
- **故障排除**: 复杂 → 简单

### 4. 部署速度
- **构建时间**: 减少40%
- **启动时间**: 减少50%
- **更新速度**: 单次部署vs多次部署

## 风险缓解

### 1. 单点故障
- **风险**: 单容器故障影响全部服务
- **缓解**: 快速重启机制 + 健康检查

### 2. 资源竞争
- **风险**: 前后端共享资源
- **缓解**: 资源使用监控 + 合理的资源限制

### 3. 扩展限制
- **风险**: 无法独立扩展前后端
- **缓解**: 当前规模下单服务足够，未来可拆分

## 回滚计划

如果新架构出现问题，可以快速回滚：

1. **保留旧配置**: 旧的 `.drone.yml` 已备份
2. **镜像回滚**: 恢复到多服务构建
3. **数据兼容**: 数据库结构未变，完全兼容
4. **配置还原**: 环境变量配置兼容

## 监控建议

### 1. 容器监控
```bash
# 监控容器状态
docker stats tggod

# 监控容器日志
docker logs -f tggod
```

### 2. 服务监控
```bash
# 健康检查
curl -f http://localhost:10200/health

# 性能监控
curl -w "@curl-format.txt" -s http://localhost:10200/
```

### 3. 资源监控
```bash
# 磁盘使用
df -h /volume1/docker/apps/tggod/

# 内存使用
docker exec tggod free -m
```

## 最佳实践

1. **定期备份**: 自动化数据备份脚本
2. **监控告警**: 服务异常时自动通知
3. **性能优化**: 定期清理日志和临时文件
4. **安全更新**: 定期更新基础镜像
5. **测试验证**: 部署前在测试环境验证